<html>
    <head>
	<style>

        @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap');

        :root {
            --light-bg: #f2f3f5;
            --light-text: #0f0f0f;
            --light-search-bg: #dfe0e2;

            --dark-bg: #2b2d31; 
            --dark-text: #cacaca;
            --dark-search-bg: #1c1d1e;

            --custom-bg: #ffffff;
            --custom-text:  #ffffff;
            --custom-search-bg:  #ffffff;

            --selected-value: 0;

        }

        .light {
            color: var(--light-text);
            background-color: var(--light-bg);
        }

        .dark {
            color: var(--dark-text);
            background-color: var(--dark-bg);
        }

	    #textarea {
	    	width: 100%;
			height: 100%;
			font-size: 1.3rem;
			outline: none;
			border: none; 
			resize: none;
			margin: 0;
            padding: 1rem;
            background-color: inherit;
            color: inherit;
        }

        body {
            margin: 0;
            font-family: "Noto Sans" !important;
        }

        .hidden {
            display: none;
        }

        #cmdP {
            position: fixed;
            z-index: 2;
            width: 30%;
            max-height: 16rem;
            background-color: inherit;
            color: inherit;

            border-style: none;
            border-width: 0.05rem;
            border-radius: 10px;

            display: grid;
            grid-auto-rows: min-content;

            overflow-y: hidden;
        }

        #cmdP::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .cmdP-input-dark {
            color: var(--dark-text);
            background: var(--dark-search-bg);
        }

        .cmdP-input-light {
            color: var(--light-text);
            background: var(--light-search-bg);
        }

        #cmdP-input {
            width: 100%;
            height: 3.5rem;

            
            padding: 12px 20px;
            font-size: 1rem;
            border-style: none;
            border-radius: 0.5rem;
            outline: transparent;
        }

        #notes-text {
            font-size: 0.8rem;
            margin: 0.5rem auto;
            user-select: none;
            width: 95%;
        }

        #notes {
            height: max-content;
            max-height: 10rem;
            overflow-y: auto;
            scrollbar-width: none;
            margin: 0 auto;
            width: 95%;
        }

        .note {
            width: 100%;
            display: flex;
            font-size: 0.9rem;
            user-select: none;
            justify-content: space-between;
            align-items: center;
            height: 2rem;
            border-radius: 10px;
        }

        .note-creation-date {
            margin: 0 0.5rem;
        }

        .note-name {
            margin: 0 0.5rem;
            width: 60%;
            text-overflow: ellipsis;
            overflow-x: hidden;
            white-space: nowrap; 
        }

        .selected {
            background-color: rgba(var(--selected-value), var(--selected-value), var(--selected-value), 0.1);
        }

	</style>
    </head>
    <body class="light">
        <textarea onkeydown="updateStorage()" id="textarea"></textarea>
        <dialog class="hidden" tabindex="-1" id="cmdP">
            <div>
                <input class="cmdP-input-light" id="cmdP-input" onkeyup="handleSearch()" type="text" placeholder="Search for notes">
                <p id="notes-text">Quiok Access</p>
            </div>
            <div id="notes">
            </div>
        </dialog>
    </body>

    <script>

        let print = (s) => { // Pov python user moment
            console.log(s); 
        }

        // Key Presses

        let cmdPOpen = false;
        let selected_index = 0;
        let max_selected = 0

        document.addEventListener("keydown", (e) => {
            if (e.ctrlKey) {
                switch (e.keyCode) {
                    case 75:
                        cmdPToggle();
                        e.preventDefault();
                        break;
                }
            } else if (cmdPOpen) {
                switch (e.keyCode) {
                    case 27:
                        cmdPToggle();
                        break;
                    case 40:
                        e.preventDefault();
                        selected_index = Math.min(selected_index + 1, max_selected);
                        handleSearch();
                        break;
                    case 38:
                        e.preventDefault();
                        selected_index = Math.max(selected_index - 1, 0);
                        handleSearch();
                        break;
                    default: 
                        figureOutWhatToDo(e, selected_index)
                        break;

                }
            } 

            // print(e);
        });

        // DB stuff

        let db;
        let note_keys = {};
        let current_key = localStorage["current_key"];
        
        let open_db = () => {
            const open_request = window.indexedDB.open("main", 1);
            
            open_request.onsuccess = (e) => {
                db = e.target.result;
                updateTextArea();
                updateNoteKeys();
            }

            open_request.onerror = (e) => {
                console.error("Error opening IndexedDB");
                console.error(e);
            }
            
            open_request.onupgradeneeded = (e) => {
                db = e.target.result;
                const storeOS = db.createObjectStore("storage", {keyPath: "key"});
                
                e.target.transaction.oncomplete = (e) => {
                    create_note("default");
                    current_key = Object.keys(note_keys)[0];
                    localStorage["current_key"] = current_key;
                }
            }
        }

        let writeToStorageNoteKeys = () => {
            let item = {
                "key": "keys",
                "content": note_keys
            }

            const tx = db.transaction("storage", "readwrite");
            const store = tx.objectStore("storage");
            let request = store.put(item);

            request.onerror = (e) => {
                console.error(e);
            }
        }

        let writeToStorageContent = (key, name, text) => {
            let item = {
                "key": key,
                "name": name,
                "content": text 
            }

            const tx = db.transaction("storage", "readwrite");
            const store = tx.objectStore("storage");
            let request = store.put(item);

            request.onerror = (e) => {
                console.error(e);
            }
        }

        let readFromStorage = (key) => {
            const tx = db.transaction("storage", "readwrite");
            const store = tx.objectStore("storage");
            let request = store.get(key);

            return request
        }

        let deleteFromStorage = (key) => {
            const tx = db.transaction("storage", "readwrite");
            const store = tx.objectStore("storage");
            let request = store.delete(key);

            request.onerror = (e) => {
                console.error(e);
            }
        }

        let updateStorage = () => {
            let textarea = document.getElementById("textarea");
            writeToStorageContent(current_key, note_keys[current_key], textarea.value);
        }

        let updateTextArea = () => {
            let textarea = document.getElementById("textarea");
            let request = readFromStorage(current_key);

            request.onsuccess = (e) => {
                textarea.value = e.target.result.content;
            }

            request.onerror = (e) => {
                console.error(e);
            }
        }

        let find_default = () => {
            let keys = Object.keys(note_keys).map((e) => { 
                return parseInt(e);
            });

            return Math.min(...keys).toString();
        }

        let change_current_note = (key) => {
            current_key = key;
            localStorage["current_key"] = current_key;
            updateTextArea();
        }

        let delete_note = (key) => {

            delete note_keys[key]
            deleteFromStorage(key);

            writeToStorageNoteKeys();
            change_current_note(find_default());
        }

        let create_note = (name) => {
            let key = Date.now().toString();
            writeToStorageContent(key, name, "");
            note_keys[key] = name;
            writeToStorageNoteKeys();

            change_current_note(key);
        }
        
        let updateNoteKeys = () => {
            let request = readFromStorage("keys");

            request.onsuccess = (e) => {
                note_keys = e.target.result.content;
            }
        }
	
        // Modal 

        let cmdPToggle = () => {
            let cmdP = document.getElementById("cmdP");
            let inp = document.getElementById("cmdP-input")
            if (cmdP.open) {
                cmdP.close();
                document.activeElement.blur();
                document.getElementById("textarea").focus();
            } else {
                selected_index = 0;
                handleSearch();
                cmdP.showModal();
            }

            cmdP.classList.toggle("hidden");
            cmdPOpen = !cmdPOpen;
        }       

        let handleSearch = () => {
            let notes = findNotes();
            let commands = findCommands();
            let total = [...notes, ...commands];

            if (max_selected == -1) {
                selected_index = 0;
            }
            max_selected = total.length - 1;

            if (selected_index > max_selected) {
                selected_index = total.length - 1;
            }

            addToCmdP(total);
        }

        let findNotes = () => {
            let search = document.getElementById("cmdP-input");
            let notes = [];
            if (search.value == "") {
                for (let key of Object.keys(note_keys)) {
                    notes.push([]);
                    notes[notes.length - 1].push(key);
                    notes[notes.length - 1].push(note_keys[key])
                }
            } else {
                for (let key of Object.keys(note_keys)) {
                    if (note_keys[key].includes(search.value)) {
                        notes.push([]);
                        notes[notes.length - 1].push(key);
                        notes[notes.length - 1].push(note_keys[key])
                    }
                }
            }

            return notes
        }

        let switch_theme = () => {
            document.body.classList.toggle("light");
            document.body.classList.toggle("dark");
            
            document.getElementById("cmdP-input").classList.toggle("cmdP-input-dark");
            document.getElementById("cmdP-input").classList.toggle("cmdP-input-light");

            let root = document.documentElement;
            let cur = getComputedStyle(root).getPropertyValue("--selected-value");
            root.style.setProperty("--selected-value", cur == "0" ? "255" : "0");

            localStorage["isLightTheme"] = document.body.classList.contains("light");
        }

        let findCommands = () => {
            let search = document.getElementById("cmdP-input")
            let searchCmds = [
                [">Toggle Theme", `Toggle ${document.body.classList.contains("light") ? "Dark" : "Light"} Mode`, switch_theme]
            ];

            let returnCmds = []

            if (search.value != "") {
                returnCmds.push([">create", "Create Note: " + search.value, create_note]);
                
                for (let cmd of searchCmds) {
                    if (cmd[1].toLowerCase().includes(search.value.toLowerCase())) {
                        returnCmds.push(cmd);
                    }
                }
            }


            return returnCmds 
        }

        let addToCmdP = (notes) => {
            let notesArea = document.getElementById("notes");

            notesArea.innerHTML = "";

            for (let i = 0; i < notes.length; i++) {
                let note = notes[i];

                let div = document.createElement("div");
                div.classList.add("note");

                if (i == selected_index) {
                    div.classList.add("selected")
                }
                
                let name = document.createElement("p");
                name.innerText = note[1];
                name.classList.add("note-name");
                div.appendChild(name);

                if (note[0][0] != ">") {
                    let date = document.createElement("p");
                    date.innerText = new Date(parseInt(note[0])).toLocaleString().split(",")[0]
                    date.classList.add("note-creation-date");
                    div.appendChild(date);
                }

                notesArea.appendChild(div);
            }

            notesArea.children[selected_index].scrollIntoView();    
        }

        let figureOutWhatToDo = (e, selected_index) => {
            let search = document.getElementById("cmdP-input");
            let total = [...findNotes(), ...findCommands()];
            let selected = total[selected_index];
            let keyCode = e.keyCode;
        
            if (keyCode == 13) {
                if (selected[0][0] != ">") {
                    change_current_note(selected[0]);
                } else {
                    switch (selected[0]) {
                        case ">create": 
                            selected[2](search.value);
                            break;
                        default:
                            selected[2]();
                            break;
                    }
                }

                cmdPToggle();
            } else if (selected[0][0] != ">" && e.altKey && (keyCode == 46 || keyCode == 8)) {
                delete_note(selected[0]);
                cmdPToggle();
            }

        }

        // Tabs 

        let add_tab = (e) => {
            
        }

        // Onload

        window.onload = (e) => {
            if (localStorage["isLightTheme"] == null) {
                localStorage["isLightTheme"] = true;
                print("I ran???")
            } else if (localStorage["isLightTheme"] === "false") {
                switch_theme();
            }


            open_db();
        }
        
    </script>
</html>
